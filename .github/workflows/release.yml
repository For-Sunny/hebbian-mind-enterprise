# Hebbian Mind Enterprise - Release Pipeline
# Author: CIPS LLC
# Build and publish releases on tag push

name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  packages: write

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run full test suite
      run: pytest tests/ -v --tb=short

    - name: Verify version matches tag
      run: |
        TAG_VERSION="${GITHUB_REF#refs/tags/v}"
        PKG_VERSION=$(python -c "import tomli; print(tomli.load(open('pyproject.toml', 'rb'))['project']['version'])")
        if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
          echo "Tag version ($TAG_VERSION) does not match package version ($PKG_VERSION)"
          exit 1
        fi
      shell: bash

  build:
    name: Build Release Packages
    runs-on: ubuntu-latest
    needs: validate

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build source distribution and wheel
      run: python -m build

    - name: Verify package integrity
      run: twine check dist/*

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-packages
        path: dist/
        retention-days: 30

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: pypi
      url: https://pypi.org/project/hebbian-mind-enterprise/

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-packages
        path: dist/

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        skip-existing: true

  publish-github:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-packages
        path: dist/

    - name: Extract release notes
      id: extract_notes
      run: |
        VERSION="${GITHUB_REF#refs/tags/v}"
        if [ -f "CHANGELOG.md" ]; then
          # Extract notes for this version from CHANGELOG
          sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d' > release_notes.md
        else
          echo "Release $VERSION" > release_notes.md
        fi

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: dist/*
        body_path: release_notes.md
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: validate
    if: github.repository == 'cipscorps/hebbian-mind-enterprise'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=sha,prefix=sha-

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  notify:
    name: Release Notifications
    runs-on: ubuntu-latest
    needs: [publish-pypi, publish-github]
    if: always()

    steps:
    - name: Check release status
      run: |
        if [ "${{ needs.publish-pypi.result }}" == "success" ] && \
           [ "${{ needs.publish-github.result }}" == "success" ]; then
          echo "Release completed successfully"
          echo "STATUS=success" >> $GITHUB_ENV
        else
          echo "Release had failures"
          echo "STATUS=failure" >> $GITHUB_ENV
          exit 1
        fi

    - name: Send success notification
      if: env.STATUS == 'success'
      run: |
        VERSION="${GITHUB_REF#refs/tags/v}"
        echo "Hebbian Mind Enterprise $VERSION released successfully"
        echo "PyPI: https://pypi.org/project/hebbian-mind-enterprise/$VERSION/"
        echo "GitHub: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
